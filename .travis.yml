sudo: required
services:
- docker
language: python
python:
  - 2.7
before_install:
  - |
    if [[ "$TRAVIS_PULL_REQUEST" != "false" ]]; then
      docker build --build-arg REPO=$TRAVIS_PULL_REQUEST_SLUG --build-arg BRANCH=$TRAVIS_PULL_REQUEST_BRANCH --build-arg COMMIT=$TRAVIS_PULL_REQUEST_SHA -t modsecurity-crs ./util/
    else
      docker build -t modsecurity-crs ./util/
    fi
  - docker run -ti -e PARANOIA=5 -d -p 80:80 -v /var/log/apache2:/var/log/apache2/ --name "$TRAVIS_BUILD_ID" modsecurity-crs
install:
  - pip install -r ./tests/integration/requirements.txt
  - pip install -r ./tests/regression/requirements.txt
script:
  - py.test -vs ./tests/integration/format_tests.py
  - py.test -vs tests/regression/CRS_Tests.py --rule=tests/regression/tests/test.yaml
  - py.test -vs tests/regression/CRS_Tests.py --ruledir=tests/regression/tests/REQUEST-911-METHOD-ENFORCEMENT
  - py.test -vs tests/regression/CRS_Tests.py --ruledir=tests/regression/tests/REQUEST-913-SCANNER-DETECTION
  - py.test -vs tests/regression/CRS_Tests.py --ruledir=tests/regression/tests/REQUEST-921-PROTOCOL-ATTACK
  - py.test -vs tests/regression/CRS_Tests.py --ruledir=tests/regression/tests/REQUEST-930-APPLICATION-ATTACK-LFI
  - py.test -vs tests/regression/CRS_Tests.py --ruledir=tests/regression/tests/REQUEST-941-APPLICATION-ATTACK-XSS
  - py.test -vs tests/regression/CRS_Tests.py --ruledir=tests/regression/tests/REQUEST-942-APPLICATION-ATTACK-SQLI
  - py.test -vs tests/regression/CRS_Tests.py --ruledir=tests/regression/tests/REQUEST-943-APPLICATION-ATTACK-SESSION-FIXATION
# safelist
branches:
  only:
  - v3.0/dev
  - v3.0/master
notifications:
  irc: "chat.freenode.net#modsecurity"
