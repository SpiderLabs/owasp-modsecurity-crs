language: python

python:
  - 2.7

sudo: required

services:
  - docker

jobs:
  allow_failures:
    - env: CONFIG=3.0-apache LOGDIR=/var/log/apache2
    - env: CONFIG=3.0-nginx LOGDIR=/var/log/nginx
  fast_finish: true
  include:
    - install:
        - pip install -r tests/integration/requirements.txt
      before_script:
        - git clone https://github.com/CRS-support/secrules_parsing
        - pip install -r secrules_parsing/requirements.txt
        - python secrules_parsing/secrules_parser.py -c -f rules/*.conf
      script:
        - py.test -vs tests/integration/format_tests.py
    - &test-common
      env: CONFIG=2.9-apache LOGDIR=/var/log/apache2
      script:
        - |
          docker run -ti -e REPO=$TRAVIS_PULL_REQUEST_SLUG -e BRANCH=$TRAVIS_PULL_REQUEST_BRANCH -d -p 80:80 \
            --volume $LOGDIR:$LOGDIR \
            --name "$TRAVIS_BUILD_ID" themiddle/crs-test
    - <<: *test-common
      env: CONFIG=3.0-apache LOGDIR=/var/log/apache2
    - <<: *test-common
      env: CONFIG=3.0-nginx LOGDIR=/var/log/nginx

# safelist
branches:
  only:
    - v3.1/dev
    - v3.2/dev
    - v3.3/dev

#notifications:
#  irc: "chat.freenode.net#modsecurity"
