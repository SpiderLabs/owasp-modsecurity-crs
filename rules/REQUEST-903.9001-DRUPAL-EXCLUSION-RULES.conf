# ------------------------------------------------------------------------
# OWASP ModSecurity Core Rule Set ver.3.0.0
# Copyright (c) 2006-2016 Trustwave and contributors. All rights reserved.
#
# The OWASP ModSecurity Core Rule Set is distributed under
# Apache Software License (ASL) version 2
# Please see the enclosed LICENSE file for full details.
# ------------------------------------------------------------------------

# These exclusions remedy false positives in a default Drupal install.
# The exclusions are only active if crs_exclusions_drupal=1 is set.
# See rule 900130 in crs-setup.conf.example for instructions.

#
# POLICY 
#
# Drupal is a complex application that is hard to secure with the CRS. This set
# of exclusion rules aims to sanitise the CRS in a way that allows a default
# Drupal install to be installed and configured without much hassle as far as
# ModSecurity and the CRS are concerned.
#
# The exclusion rules are fairly straight forward in the sense that they
# disable CRS on a set of well-known parameter fields, that are known to be a
# source of false positives / false alarms of the CRS. This includes namely the
# password fields and article/node bodies.
#
# This is based on two assumptions: 
# - You have a basic trust in your authenticated users who are allowed to 
#   edit nodes.  
# - Drupal allows html content in nodes and protects your users from attacks 
#   via these fields.
#
# If you think these assumptions are wrong or if you would prefer a more
# careful/secure approach, you can disable the exclusion rules handling said
# node body false positives. Do this by placing the following directive in
# RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf.
#
# SecRuleRemoveById 9001200-9001299
#
# This will mean the CRS remain intact for the editing of node bodies.
#
# The CRS rules covered by this ruleset are the rules with Paranoia Level 1 and
# 2. If you chose to run Paranoia Level 3 or 4, you will be facing additional
# false positives which you need to handle yourself.
#
# This set of exclusion rules does not cover any additional Drupal modules
# outside of core.
#
# The exclusion rules are based on a Drupal 8.1.10.
#
# And finally: This set of exclusion rules is in an experimental stage. If you
# encounter false positives with the basic Drupal functionality and they are
# not covered by this rule file, then please report them. The aim is to be able
# to run Drupal core in a seamless manner protected by ModSecurity / CRS up to
# the paranoia level 2.


SecRule &TX:crs_exclusions_drupal|TX:crs_exclusions_drupal "@eq 0" \
	"id:9001000,\
	phase:2,\
	t:none,\
	nolog,\
	pass,\
	skipAfter:END-DRUPAL-RULE-EXCLUSIONS"


#
# [ Password ]
#
# Disable the CRS completely for all occurrences of passwords.
#
SecRule REQUEST_FILENAME "@endsWith /core/install.php" \
	"id:9001100,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:account[pass][pass1],\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:account[pass][pass2]"

SecRule REQUEST_FILENAME "@endsWith /user/login" \
	"id:9001110,\
	phase:2,\
	t:none,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:pass"

SecRule REQUEST_FILENAME "@endsWith /admin/people/create" \
	"id:9001120,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:pass[pass1],\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:pass[pass2]"

SecRule REQUEST_FILENAME "@rx /user/[0-9]+/edit$" \
	"id:9001130,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:current_pass,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:pass[pass1],\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:pass[pass2]"


#
# [ Content and Descriptions ]
#
# Disable the CRS completely for node bodies and other free text fields.
# Rule Exclusion for ARGS:uid[0][target_id]: 942410 SQL Injection Attack 
#
SecRule REQUEST_FILENAME "@endsWith /node/add/article" \
	"id:9001200,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:body[0][value],\
	ctl:ruleRemoveTargetById=942410;ARGS:uid[0][target_id]"

SecRule REQUEST_FILENAME "@endsWith /node/add/page" \
	"id:9001210,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:body[0][value],\
	ctl:ruleRemoveTargetById=942410;ARGS:uid[0][target_id]"

SecRule REQUEST_FILENAME "@rx /node/[0-9]+/edit$" \
	"id:9001220,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:body[0][value],\
	ctl:ruleRemoveTargetById=942410;ARGS:uid[0][target_id]"

SecRule REQUEST_FILENAME "@endsWith /block/add" \
	"id:9001230,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:body[0][value]"

SecRule REQUEST_FILENAME "@endsWith /admin/structure/block/block-content/manage/basic" \
	"id:9001240,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:description"

SecRule REQUEST_FILENAME "@rx /editor/filter_xss/(full|basic)_html$" \
	"id:9001250,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:value"

SecRule REQUEST_FILENAME "@rx /user/[0-9]+/contact$" \
	"id:9001260,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:message[0][value]"

SecRule REQUEST_FILENAME "@endsWith /admin/config/development/maintenance" \
	"id:9001270,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:maintenance_mode_message"

SecRule REQUEST_FILENAME "@endsWith /admin/config/services/rss-publishing" \
	"id:9001280,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:feed_description"


#
#
# [ Content and Descriptions ]
# 
# Disable known false positives for field "ids[]":
#
# Rule Exclusion: 942130 SQL Injection Attack: SQL Tautology Detected
#
SecRule REQUEST_FILENAME "@endsWith /contextual/render" \
	"id:9001300,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetById=942130;ARGS:ids[]"


#
# [ Themes Settings ]
# 
# Disable known false positives for field "form_build_id"
#
# Rule Exclusion: 942440 SQL Comment Sequence Detected
#
SecRule REQUEST_FILENAME "@contains /admin/appearance/settings/" \
	"id:9001310,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetById=942440;ARGS:form_build_id"


#
# [ Admin Settings (general) ]
# 
# Rule Exclusion: 920271 Invalid character in request on multiple fields/paths
# Rule Exclusion: 942440 SQL Comment Sequence Detected on multiple fields/paths
# Rule Exclusion: 942430 Restricted SQL Character Anomaly Detection (args)
# 			 Disabled completely for admin/config pages
# For the people/accounts page, we disable the CRS completely for a number of
# freeform text fields.
#
SecRule REQUEST_FILENAME "@contains /admin/appearance/settings/" \
	"id:9001320,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetById=942440;ARGS:form_build_id"

SecRule REQUEST_FILENAME "@contains /admin/config/" \
	"id:9001330,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveById=942430"

SecRule REQUEST_FILENAME "@endsWith /admin/config/people/accounts" \
	"id:9001340,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveById=920271,\
	ctl:ruleRemoveById=942440,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:user_mail_cancel_confirm_body,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:user_mail_password_reset_body,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:user_mail_register_admin_created_body,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:user_mail_register_no_approval_required_body,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:user_mail_register_pending_approval_body,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:user_mail_status_activated_body,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:user_mail_status_blocked_body,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:user_mail_status_canceled_body"


SecRule REQUEST_FILENAME "@endsWith /admin/config/development/configuration/single/import" \
	"id:9001350,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveById=920271,\
	ctl:ruleRemoveById=942440"

SecRule REQUEST_FILENAME "@endsWith /admin/config/development/maintenance" \
	"id:9001360,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveById=942440"


#
# [ Form Token ]
# 
# Rule Exclusion: 942450 SQL Hex Encoding Identified on field "form_token"
#
# This is applied site-wide.
#
SecAction "id:9001370,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetById=942450;ARGS:form_token"


#
# [ Text Formats and Editors ]
# 
# Disable the CRS completely for two fields triggering many, many rules
#
# Rule Exclusion: 942440 SQL Comment Sequence Detected
#
SecRule REQUEST_FILENAME "@endsWith /admin/config/content/formats/manage/full_html" \
        "id:9001380,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:editor[settings][toolbar][button_groups],\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:filters[filter_html][settings][allowed_html]"

#
# [ Session Cookie ]
# 
# Giving the session cookie a dynamic name is most unfortunate
# from a ModSecurity perspective. The rule language does not allow
# us to disable rules in a granular way for individual cookies with
# dynamic ways. So we need to disable them for all cookies.
#
# Rule Exclusion: 942450 SQL Hex Encoding Identified
#
SecAction "id:9001380,\
	phase:2,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetById=942450;REQUEST_COOKIES_NAMES,\
	ctl:ruleRemoveTargetById=942450;REQUEST_COOKIES" 


#
# [ WYSIWYG/CKEditor assets and upload ]
# 
# Disable the unnecessary requestBodyAccess and for binary uploads
#
# 
#
SecRule REQUEST_METHOD "^POST$" \
        "id:'9001390',\
        phase:1,\
        t:none,\
        pass,\
        nolog,\
        noauditlog,\
        chain"
                SecRule REQUEST_FILENAME "/admin/content/assets/add/[a-z]+$" chain
                SecRule REQUEST_COOKIES:/S?SESS[a-f0-9]+/ "^[a-zA-Z0-9_-]+" \
                ctl:requestBodyAccess=Off,ctl:ruleRemoveById=200004

SecRule REQUEST_METHOD "^POST$" \
        "id:'9001400',\
        phase:1,\
        t:none,\
        pass,\
        nolog,\
        noauditlog,\
        chain"
                SecRule REQUEST_FILENAME "/admin/content/assets/manage/[0-9]+$" chain
                SecRule ARGS:destination "@eq admin/content/assets" chain
                SecRule REQUEST_HEADERS:Content-Length "@gt 31486341" chain
                SecRule REQUEST_COOKIES:/S?SESS[a-f0-9]+/ "^[a-zA-Z0-9_-]+" \
                ctl:requestBodyAccess=Off

SecRule REQUEST_METHOD "^POST$" \
        "id:'9001410',\
        phase:1,\
        t:none,\
        pass,\
        nolog,\
        noauditlog,\
        chain"
                SecRule REQUEST_FILENAME "/file/ajax/field_asset_[a-z0-9_]+/und/0/form-[a-z0-9A-Z_-]+$" chain
                SecRule REQUEST_HEADERS:Content-Length "@gt 31486341" chain
                SecRule REQUEST_HEADERS:Content-Type "@rx ^multipart/form-data" chain
                SecRule REQUEST_COOKIES:/S?SESS[a-f0-9]+/ "^[a-zA-Z0-9_-]+" \
                ctl:requestBodyAccess=Off

SecMarker END-DRUPAL-RULE-EXCLUSIONS
