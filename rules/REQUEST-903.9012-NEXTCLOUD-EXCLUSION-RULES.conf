# ------------------------------------------------------------------------
# OWASP ModSecurity Core Rule Set ver.3.0.2
# Copyright (c) 2006-2016 Trustwave and contributors. All rights reserved.
#
# The OWASP ModSecurity Core Rule Set is distributed under
# Apache Software License (ASL) version 2
# Please see the enclosed LICENSE file for full details.
#
# ------------------------------------------------------------------------

# These exclusions remedy false positives in a default NextCloud install.
# The exclusions are only active if crs_exclusions_nextcloud=1 is set.
# See rule 900131 in crs-setup.conf.example for instructions.
#
# A basic example of enabling it only within a specific site's config file:

#  SecAction \
#    "id:900132,\
#    phase:1,\
#    nolog,\
#    pass,\
#    t:none,\
#    setvar:tx.crs_exclusions_nextcloud=1"


#
# If you have issues uploading/downloading files, you can relax the restrictions. Only do
# this if you have to, as changing this could open up your system to attacks.
#
# remote.php and index.php are the files that handle these, so we can relax the restrictions
# for only these files, and leave the higher restrictions in place for the other files.
#
# Rule 900240 in crs-setup.conf explains this and has examples and default values. Below
# is an example for NextCloud, allowing the exception for _only_ the script that does the uploading.
#
# Remember that the restricted_extensions is the *blocked* extensions (not allowed),
# which you will need to modify for your needs.
#

#SecRule REQUEST_FILENAME "@rx /(remote.php|index.php)/" \
#   "id:9012330,\
#   phase:1,\
#   t:none,\
#   nolog,\
#   pass,\
#   tx.restricted_extensions='.bak/ .config/ .conf/ .db/ .ini/ .log/ .old/ .pass/ .pdb/ .sql/'"

#
# If you have issues with uploading large files, you may need to modify SecRequestBodyLimit. See https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual#secrequestbodylimit

# ---------------------


SecRule &TX:crs_exclusions_nextcloud|TX:crs_exclusions_nextcloud "@eq 0" \
	"id:9012000,\
	phase:1,\
	t:none,\
	nolog,\
	pass,\
	skipAfter:END-NEXTCLOUD"

SecRule &TX:crs_exclusions_nextcloud|TX:crs_exclusions_nextcloud "@eq 0" \
	"id:9012001,\
	phase:2,\
	t:none,\
	nolog,\
	pass,\
	skipAfter:END-NEXTCLOUD"


## File Manager

SecRule REQUEST_FILENAME "@contains /remote.php/webdav" \
   "id:9012010,\
   phase:2,\
   t:none,\
   nolog,\
   pass,\
   ctl:ruleRemoveByID=933100-933200,\
   ctl:ruleRemoveByID=941000-942999,\
   ctl:ruleRemoveByID=920420"


##File Manager. Allow the data type 'text/vcard'

SecRule REQUEST_FILENAME "@contains /remote.php/dav/files/" \
   "id:9012011,\
   phase:2,\
   t:none,\
   nolog,\
   pass,\
   setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type}|text/vcard'"


## File Manager. Allow characters like /../ in files.

SecRule REQUEST_FILENAME "@contains /remote.php/dav/files/" \
   "id:9012212,\
   phase:2,\
   t:none,\
   nolog,\
   pass,\
   ctl:ruleRemoveByID=930100-930110"


# allow dav methods to be called on report.php and index.php (must be phase:2)
# the default ones in ModSecurity are: GET HEAD POST OPTIONS
# I put more than I saw in the code. Perhaps we can remove the extras?
# File manager: PUT DELETE MOVE PROPFIND PROPPATCH
# Calendars: REPORT
# Others in the code or js files: PATCH MKCOL MOVE TRACE
# Others that I added just in case, and they seem related:
#   CHECKOUT COPY LOCK MERGE MKACTIVITY UNLOCK:
# These I have found by searching info on dav, but I
# don't know if we need them, so they are not included:
#   BCOPY BDELETE BMOVE BPROPFIND BPROPPATCH NOTIFY POLL SEARCH SUBSCRIBE UNSUBSCRIBE

SecRule REQUEST_FILENAME "@rx /(remote.php|index.php)/" \
   "id:9012020,\
   phase:2,\
   t:none,\
   nolog,\
   pass,\
   setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT PATCH CHECKOUT COPY DELETE LOCK MERGE MKACTIVITY MKCOL MOVE PROPFIND PROPPATCH UNLOCK REPORT TRACE jsonp'"

# for sharing files, and removing the share
# DELETE - when the share is removed
# PUT - when setting a password / expiration time
SecRule REQUEST_FILENAME "@contains /ocs/v2.php/apps/files_sharing/" \
   "id:9012030,\
   phase:2,\
   t:none,\
   nolog,\
   pass,\
   setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT DELETE'"

# for /index.php/core/preview.png
SecRule REQUEST_FILENAME "@contains /index.php/core/preview.png" \
   "id:9012050,\
   phase:2,\
   t:none,\
   nolog,\
   pass,\
   ctl:ruleRemoveTargetByID=932150;ARGS:file"

# For showing thumbnails
SecRule REQUEST_FILENAME "@contains /index.php/apps/gallery/thumbnails" \
   "id:9012070,\
   phase:2,\
   t:none,\
   nolog,\
   pass,\
   ctl:ruleRemoveByID=941120;ARGS:requesttoken"


# Note: this rule was only blocking it, it didn't show the number
# but was able to do some trial and error and find it.
SecRule REQUEST_FILENAME "@contains /index.php/apps/ownnote/" \
   "id:9012100,\
   phase:2,\
   t:none,\
   nolog,\
   pass,\
   ctl:ruleRemoveByID=941150"


# Text Editor. This file can save anything, and it's name could be lots of things.
SecRule REQUEST_FILENAME "@contains /index.php/apps/files_texteditor/" \
   "id:9012110,\
   phase:2,\
   t:none,\
   nolog,\
   pass,\
   ctl:ruleRemoveTargetByTag=CRS;ARGS:filecontents,\
   ctl:ruleRemoveTargetByID=921110-921160;ARGS:filecontents,\
   ctl:ruleRemoveByID=932150;ARGS:filename,\
   ctl:ruleRemoveByID=920370-920390;ARGS:filecontents,\
   ctl:ruleRemoveByID=920370-920390;ARGS_COMBINED_SIZE"


## Address Book. Allow the data type 'text/vcard'
SecRule REQUEST_FILENAME "@contains /remote.php/dav/addressbooks/" \
   "id:9012120,\
   phase:2,\
   t:none,\
   nolog,\
   pass,\
   setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type}|text/vcard'"

## Calendar. Allow the data type 'text/calendar'
SecRule REQUEST_FILENAME "@contains /remote.php/dav/calendars/" \
   "id:9012125,\
   phase:2,\
   t:none,\
   nolog,\
   pass,\
   setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type}|text/calendar'"

# Notes
SecRule REQUEST_FILENAME "@contains /index.php/apps/notes/" \
   "id:9012130,\
   phase:2,\
   t:none,\
   nolog,\
   pass,\
   ctl:ruleRemoveByID=933100-933300"

# Bookmarks. Allow urls in data
SecRule REQUEST_FILENAME "@contains /index.php/apps/bookmarks/" \
   "id:9012135,\
   phase:2,\
   t:none,\
   nolog,\
   pass,\
   ctl:ruleRemoveByID=931130"


#
# [ Login form ]
#

# User login password
SecRule REQUEST_FILENAME "@contains /index.php/login" \
	"id:9012200,\
	phase:2,\
	t:none,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:password"

# Reset password

SecRule REQUEST_FILENAME "@endsWith /index.php/login" \
	"id:9012210,\
	phase:2,\
	t:none,\
	nolog,\
	pass,\
	chain"
	SecRule ARGS:action "@streq resetpass" \
		"t:none,\
		chain"
	SecRule &ARGS:action "@eq 1" \
		"t:none,\
		ctl:ruleRemoveTargetByTag=CRS;ARGS:pass1,\
		ctl:ruleRemoveTargetByTag=CRS;ARGS:pass1-text,\
		ctl:ruleRemoveTargetByTag=CRS;ARGS:pass2"
		

# Change Password and Setting up a new user/password

SecRule REQUEST_FILENAME "@endsWith /index.php/settings/users" \
	"id:9012220,\
	phase:2,\
	t:none,\
	nolog,\
	pass,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:newuserpassword,\
	ctl:ruleRemoveTargetByTag=CRS;ARGS:password"

# could I add a check for the 'oc_sessionPassphrase' cookie?
# but don't know if that's always there....

########################################################
# Testing for upload fix
#
# You can set the crs_nextcloud_max_upload variable to the max upload size, such as:
#
#  SecAction \
#    "id:900132,\
#    phase:1,\
#    nolog,\
#    pass,\
#    t:none,\
#    setvar:tx.crs_nextcloud_max_upload=1073741824,\
#    setvar:tx.crs_exclusions_nextcloud=1"
#
### Increase upload IF the user asked for it:
#
#SecRule &TX:crs_nextcloud_max_upload|TX:crs_nextcloud_max_upload "@eq 0" \
#	"id:9012600,\
#	phase:1,\
#	t:none,\
#	nolog,\
#	pass,\
#	skipAfter:END-NEXTCLOUD-INCREASE-UPLOAD"
#
### Request Body configued limit of 32768000 by default
#SecRule REQUEST_URI "@endsWith /index.php/apps/files/ajax/upload.php" \
#    "id:9012610,\
#    phase:1,\
#    t:none,\
#    nolog,\
#    ctl:requestBodyLimit=%{tx.crs_nextcloud_max_upload}'"
#
#SecMarker END-NEXTCLOUD-INCREASE-UPLOAD"
#
##########################################################

SecMarker END-NEXTCLOUD-ADMIN


SecMarker END-NEXTCLOUD
