# ------------------------------------------------------------------------
# OWASP ModSecurity Core Rule Set ver.3.0.2
# Copyright (c) 2006-2016 Trustwave and contributors. All rights reserved.
#
# The OWASP ModSecurity Core Rule Set is distributed under
# Apache Software License (ASL) version 2
# Please see the enclosed LICENSE file for full details.
#
# ------------------------------------------------------------------------

# These exclusions remedy false positives in a default Dokuwiki install.
# The exclusions are only active if crs_exclusions_dokuwiki=1 is set.
# See rule 900131 in crs-setup.conf.example for instructions.
#
# A basic example of setting it within a site's config file:
#
#  SecAction \
#    "id:900132,\
#    phase:1,\
#    nolog,\
#    pass,\
#    t:none,\
#    setvar:tx.crs_exclusions_dokuwik=1"


# If you have issues uploading/downloading files, you can relax the restrictions. Only do
# this if you have to, as changing this could open up your system to attacks.
#
# Rule 900240 in crs-setup.conf explains this and has examples and default values.
# Below is an example for Dokuwiki, allowing the exception for _only_ the script that does the uploading.
#
# Remember that the restricted_extensions is the *blocked* extensions (not allowed),
# which you will need to modify for your needs.


# SecRule REQUEST_FILENAME "@endsWith /lib/exe/ajax.php"\
#    "id:901111,\
#    phase:1,\
#    t:none,\
#    nolog,\
#    pass,\
#    chain"
#    SecRule REQUEST_COOKIES:/S?DW[a-f0-9]+/ '@rx ^[%a-zA-Z0-9_-]+' \
#      "t:none,\
#      tx.restricted_extensions='.bak/ .config/ .conf/ .db/ .ini/ .log/ .old/ .pass/ .pdb/ .sql/'"




SecRule &TX:crs_exclusions_dokuwiki|TX:crs_exclusions_dokuwiki "@eq 0" \
	"id:9011000,\
	phase:1,\
	t:none,\
	nolog,\
	pass,\
	skipAfter:END-DOKUWIKI"

SecRule &TX:crs_exclusions_dokuwiki|TX:crs_exclusions_dokuwiki "@eq 0" \
	"id:9011001,\
	phase:2,\
	t:none,\
	nolog,\
	pass,\
	skipAfter:END-DOKUWIKI"

# Note: I have tagged most rules by a url, and the do=action arg, in
# order to make sure we only allow that page/url.

#
# -=[ Dokuwiki Front-End ]=-
#

#
# -=[ Dokuwiki Back-End ]=-
#

# Allow pages to be edited, and ajax to save drafts.
# 933100 933150 933160
# [tag "attack-injection-php"]
# [tag "attack-protocol"]
# 942350
# [tag "attack-sqli"] (lots)
# if you don't use permalinks, you may be able
# to use 'SecRule REQUEST_FILENAME "@endsWith doku.php'
# but otherwise this has to be global, as it can be with/out
# the do=edit, or with/out the any uri.
# 921110-921160 get hit with odd characters in the page.
# -> should not need others, unless using higher level of paranoia
# 930110;REQUEST_BODY if for if there's  a /../ in the text.
SecAction "id:9011100,\
   phase:2,\
   t:none,\
   nolog,\
   pass,\
   chain"
    SecRule REQUEST_METHOD "@streq POST" \
     "t:none,\
     chain"
     SecRule REQUEST_COOKIES:/S?DW[a-f0-9]+/ '@rx ^[%a-zA-Z0-9_-]+' \
       "t:none,\
   ctl:ruleRemoveTargetByTag=CRS;ARGS:wikitext,\
   ctl:ruleRemoveTargetByID=921110-921160;ARGS:wikitext,\
   ctl:ruleRemoveTargetByID=930110;REQUEST_BODY,\
   ctl:ruleRemoveTargetByTag=CRS;ARGS:suffix,\
   ctl:ruleRemoveTargetByID=921110-921160;ARGS:suffix"

# for ajax save drafts. can't used do=edit.
#SecRule REQUEST_FILENAME "@endsWith lib/exe/ajax.php" \
#   "id:9011101,\
#   phase:2,\
#   t:none,\
#   nolog,\
#   pass,\
#   ctl:ruleRemoveTargetByTag=CRS;ARGS:wikitext,\
#   ctl:ruleRemoveTargetByID=921110;ARGS:wikitext,\
#   ctl:ruleRemoveTargetByTag=CRS;ARGS:suffix,\
#   ctl:ruleRemoveTargetByID=921110;ARGS:suffix"

#SecRule REQUEST_FILENAME "@beginsWith /doku.php" \
#   "id:9050004,phase:2,t:none,nolog,pass,\
#    chain"
#    SecRule ARGS:do "@streq edit" \
#      "ctl:ruleRemoveTargetByID=933100;ARGS:wikitext"

#SecRule REQUEST_FILENAME "@endsWith /lib/exe/ajax.php" \
#   "id:9050004,phase:2,t:none,nolog,pass,\
#    chain"
#    SecRule ARGS:do "@streq edit" \
#      "ctl:ruleRemoveTargetByID=933100;ARGS:wikitext"


# Allow it to upload files. But check for cookies and things.

SecRule REQUEST_FILENAME "@endsWith /lib/exe/ajax.php"\
   "id:9011110,\
   phase:2,\
   t:none,\
   pass,\
   nolog,\
   noauditlog,\
   chain"
    SecRule REQUEST_METHOD "@streq POST" \
     "t:none,\
     chain"
     SecRule REQUEST_COOKIES:/S?DW[a-f0-9]+/ '@rx ^[%a-zA-Z0-9_-]+' \
       "t:none,\
       setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type}|application/octet-stream'"

# If it's large, turn off scanning
SecRule REQUEST_FILENAME "@endsWith /lib/exe/ajax.php"\
   "id:9011120,\
   phase:2,\
   t:none,\
   pass,\
   nolog,\
   noauditlog,\
   chain"
   SecRule REQUEST_HEADERS:Content-Length "@gt 31486341" \
   "t:none,\
    ctl:requestBodyAccess=Off"


#
# [ Login form ]
#

# User login password (optional)
#SecRule REQUEST_FILENAME "@contains /doku.php" \
#   "id:9011200,\
#   phase:1,\
#   t:none,\
#   pass,\
#   nolog,\
#   noauditlog,\
#   chain"
#   SecRule ARGS:do "@streq login" \
#      "t:none,\
#      ctl:ruleRemoveTargetByTag=CRS;ARGS:p"

SecRule ARGS:do "@streq login" \
  "id:9011200,\
   phase:2,\
   t:none,\
   pass,\
   nolog,\
   noauditlog,\
   ctl:ruleRemoveTargetByTag=CRS;ARGS:p,\
   ctl:ruleRemoveTargetByTag=CRS;ARGS:u"


# Reset password
SecRule REQUEST_FILENAME "@endsWith /doku.php" \
   "id:9011210,\
   phase:2,\
   t:none,\
   pass,\
   nolog,\
   noauditlog,\
   chain"
   SecRule ARGS:do "@streq login" \
      "t:none,\
      ctl:ruleRemoveTargetByTag=CRS;ARGS:pass1,\
      ctl:ruleRemoveTargetByTag=CRS;ARGS:pass1-text,\
      ctl:ruleRemoveTargetByTag=CRS;ARGS:pass2"



SecMarker END-DOKUWIKI-ADMIN


SecMarker END-DOKUWIKI
